–û–∫, —Ü–µ –≤–∂–µ **`logServerAction.js` (—Å—Ç–∞—Ä–∏–π —à–ª—è—Ö `utils/logServerAction.js`)** ‚Äî **—Å–µ—Ä–≤–µ—Ä–Ω–∞ —É—Ç–∏–ª—ñ—Ç–∞ –¥–ª—è –ª–æ–≥—É–≤–∞–Ω–Ω—è** (winston + jwtVerify, –¥—ñ—Å—Ç–∞—î username –∑ ETLS —Ç–æ–∫–µ–Ω–∞).

---

## 1) –ö—É–¥–∏ –∫–ª–∞—Å—Ç–∏ –≤ –Ω–æ–≤—ñ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ñ

–¶–µ 100% **shared**, –±–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏–º—É—Ç—å —Ä—ñ–∑–Ω—ñ —Ñ—ñ—á—ñ.

‚úÖ –ù–æ–≤–∏–π —à–ª—è—Ö:

```
src/shared/server/log/logServerAction.js
```

(–º–æ–∂–Ω–∞ –∫–æ—Ä–æ—Ç—à–µ `src/shared/server/log.js`, –∞–ª–µ –∫—Ä–∞—â–µ –ø–∞–ø–∫–æ—é, –±–æ –ø–æ—Ç—ñ–º –¥–æ–¥–∞—Å–∏ —ñ–Ω—à—ñ –ª–æ–≥-—Ö–µ–ª–ø–µ—Ä–∏.)

---

## 2) –ó—ñ–±—Ä–∞–Ω–∏–π —Ñ–∞–π–ª –∑—ñ —Å–∫—Ä—ñ–Ω—ñ–≤ (—è–∫ —î)

### ‚úÖ `src/shared/server/log/logServerAction.js`

```js
"use server"; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ server-side —Ñ—É–Ω–∫—Ü—ñ—é

export const config = {
  runtime: "nodejs",
};

import fs from "fs";
import path from "path";
import { jwtVerify } from "jose";
import DailyRotateFile from "winston-daily-rotate-file";
import { createLogger, format, transports } from "winston";

// –§–æ—Ä–º–∞—Ç —á–∞—Å—É 12.03.2025 12:10:14
const timeFormat = () => {
  const now = new Date();
  return now.toLocaleString("uk-UA", { timeZone: "Europe/Kiev" }).replace(",", "");
};

// –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ª–æ–≥—ñ–Ω—É –∑ JWT (–∑ cookies)
async function getUserLoginFromToken(token) {
  try {
    if (!token) return "UnknownUser"; // –Ø–∫—â–æ —Ç–æ–∫–µ–Ω–∞ –Ω–µ–º–∞

    const secretKey = new TextEncoder().encode(process.env.ETLS_ACCESS);
    const { payload } = await jwtVerify(token, secretKey);

    return payload.username || "UnknownUser"; // üîπ –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ `username`
  } catch (error) {
    return "UnknownUser"; // –Ø–∫—â–æ –ø–æ–º–∏–ª–∫–∞
  }
}

// –û—Å–Ω–æ–≤–Ω–∏–π –ª–æ–≥–µ—Ä (–∑–≤–∏—á–∞–π–Ω—ñ –ª–æ–≥–∏)
const infoLogger = createLogger({
  level: "info",
  format: format.combine(
    format.timestamp({ format: "DD.MM.YYYY HH:mm:ss" }), // –§–æ—Ä–º–∞—Ç —á–∞—Å—É
    format.printf(
      ({ timestamp, level, message }) =>
        `[${timestamp}] ${level.toUpperCase()}: ${message}`,
    ),
  ),
  transports: [
    new transports.Console(),
    // new DailyRotateFile({
    //   filename: 'logs/app-%DATE%.log',
    //   datePattern: 'YYYY-MM-DD',
    //   maxSize: '5m',
    //   maxFiles: '14d',
    // }),
  ],
});

// –õ–æ–≥–µ—Ä –¥–ª—è –ø–æ–º–∏–ª–æ–∫
const errorLogger = createLogger({
  level: "error",
  format: format.combine(
    format.timestamp({ format: "DD.MM.YYYY HH:mm:ss" }),
    format.printf(
      ({ timestamp, level, message }) =>
        `[${timestamp}] ${level.toUpperCase()}: ${message}`,
    ),
  ),
  transports: [
    new transports.Console(),
    // new DailyRotateFile({
    //   filename: 'logs/errors-%DATE%.log',
    //   datePattern: 'YYYY-MM-DD',
    //   maxSize: '5m',
    //   maxFiles: '14d',
    // }),
  ],
});

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–ø–∏—Å—É –ª–æ–≥—ñ–≤ —É –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π —Ñ–∞–π–ª
export async function logToFile(level, message, token) {
  try {
    const login = await getUserLoginFromToken(token); // ‚ô¶ –û—Ç—Ä–∏–º—É—î–º–æ –ª–æ–≥—ñ–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

    const logMessage = `[${timeFormat()}] ${level.toUpperCase()} [${login}]: ${message}`;

    if (level === "error") {
      errorLogger.error(logMessage);
    } else {
      infoLogger.info(logMessage);
    }

    return { success: true };
  } catch (error) {
    console.error("Error writing log:", error);
    return { success: false, error: "Failed to write log" };
  }
}
```

---

## 3) –©–æ —Ç—É—Ç ‚Äú–∑–∞–π–≤–µ/–ø—ñ–¥–æ–∑—Ä—ñ–ª–µ‚Äù, –∞–ª–µ —è –ù–ï –∑–º—ñ–Ω—é—é –±–µ–∑ —Ç–≤–æ—î—ó –∫–æ–º–∞–Ω–¥–∏

1. **`fs`, `path`, `DailyRotateFile` —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω—ñ, –∞–ª–µ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è** (–±–æ rotate –∑–∞–∫–æ–º–µ–Ω—Ç–æ–≤–∞–Ω–∏–π).
2. `toLocaleString(...).replace(",", "")` ‚Äî –æ–∫, –∞–ª–µ —Ñ–æ—Ä–º–∞—Ç –º–æ–∂–µ ‚Äú–ø–ª–∏—Å—Ç–∏‚Äù –º—ñ–∂ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞–º–∏.
3. `process.env.ETLS_ACCESS` ‚Äî –≤–∞–∂–ª–∏–≤–æ, —â–æ–± –±—É–≤ –¥–æ—Å—Ç—É–ø–Ω–∏–π —É server runtime.

–Ø–∫—â–æ —Ö–æ—á–µ—à ‚Äî –ø–æ—Ç—ñ–º –∑—Ä–æ–±–∏–º–æ —á–∏—Å—Ç—É –≤–µ—Ä—Å—ñ—é (–±–µ–∑ –º–µ—Ä—Ç–≤–∏—Ö —ñ–º–ø–æ—Ä—Ç—ñ–≤, –∑ rotate —ñ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º –ø–∞–ø–∫–∏ `logs/`).

---

## 4) –Ø–∫ –º—ñ–Ω—è—î—Ç—å—Å—è —ñ–º–ø–æ—Ä—Ç

–ë—É–ª–æ:

```js
import { logToFile } from "@/utils/logServerAction";
```

–°—Ç–∞—î:

```js
import { logToFile } from "@/shared/server/log/logServerAction";
```

---

–ö–∏–¥–∞–π –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ñ–∞–π–ª. –Ø–∫—â–æ –≤ —Ç–µ–±–µ —î —Ñ–∞–π–ª, —è–∫–∏–π –≤–∏–∫–ª–∏–∫–∞—î `logToFile(...)` (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ API route `/api/rest/...`) ‚Äî —Å–∫–∏–Ω—å –π–æ–≥–æ, —ñ —è –æ–¥—Ä–∞–∑—É –ø–æ–∫–∞–∂—É —è–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äú–≤–º–æ–Ω—Ç—É–≤–∞—Ç–∏‚Äù –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤ –Ω–æ–≤—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É.
