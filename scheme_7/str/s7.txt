–û–∫, —Ü–µ **`pages/api/auth/refreshtoken.js`**. –ü–µ—Ä–µ–Ω–æ—Å–∏–º–æ –≤ App Router —è–∫:

‚úÖ **NEW:** `src/app/api/auth/refreshtoken/route.js`

–¢—É—Ç –æ–¥—Ä–∞–∑—É 2 –≤–∞–∂–ª–∏–≤—ñ –ø—Ä–∞–≤–∫–∏ –ø—ñ–¥ App Router:

1. `req.cookies.get(...)` –≤ route handler **–Ω–µ –∑–∞–≤–∂–¥–∏ –ø—Ä–∞—Ü—é—î —è–∫ —Ç–∏ –æ—á—ñ–∫—É—î—à** ‚Äî —Å—Ç–∞–±—ñ–ª—å–Ω–æ —á–∏—Ç–∞—î–º–æ —á–µ—Ä–µ–∑ `cookies()` –∑ `next/headers`, –∞–±–æ –±–µ—Ä–µ–º–æ `req.headers.get('cookie')` —ñ –ø–∞—Ä—Å–∏–º–æ.
2. `Set-Cookie` —á–µ—Ä–µ–∑ `.join(', ')` ‚Äî **–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ**. –°—Ç–∞–≤–∏–º–æ —á–µ—Ä–µ–∑ `response.cookies.set()`.

–Ü —â–µ: —É —Ç–≤–æ—î–º—É –∫–æ–¥—ñ —î `logoutUser(req)` –∑ `utils/auth` ‚Äî —É App Router –∫—Ä–∞—â–µ —Ä–æ–±–∏—Ç–∏ –ª–æ–∫–∞–ª—å–Ω—É ‚Äúlogout-–≤—ñ–¥–ø–æ–≤—ñ–¥—å‚Äù –ø—Ä—è–º–æ —Ç—É—Ç (–æ—á–∏—Å—Ç–∏—Ç–∏ cookies + 401), —â–æ–± –Ω–µ —Ç—è–≥–Ω—É—Ç–∏ –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –≤—ñ–¥ —Å—Ç–∞—Ä–æ–≥–æ utils.

---

## 1) –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–∏–π –∫–æ–¥ –∑—ñ —Å–∫—Ä—ñ–Ω—ñ–≤ (—è–∫ –±—É–ª–æ)

> **OLD:** `pages/api/auth/refreshtoken.js`

```js
export const runtime = 'edge'
import { NextResponse } from 'next/server'
import { jwtVerify, SignJWT } from 'jose'
import { logoutUser } from '../../../../utils/auth'

const ETLS_ACCESS = new TextEncoder().encode(process.env.ETLS_ACCESS)
const ETLS_REFRESH = new TextEncoder().encode(process.env.ETLS_REFRESH)
const EXPIRES_IN_ACCESS_ETLS = parseInt(process.env.ETLS_ACCESS_EXPIRE_TIME)
const EXPIRES_IN_REFRESH_ETLS = parseInt(process.env.ETLS_REFRESH_EXPIRE_TIME)

export default async function POST(req, res, next) {
  try {
    // –û—Ç—Ä–∏–º—É—î–º–æ cookies
    const cookieStore = req.cookies
    const refreshTokenEtls = cookieStore.get('refreshTokenEtls')?.value

    // —è–∫—â–æ refresh token –≤—ñ–¥—Å—É—Ç–Ω—ñ–π
    if (!refreshTokenEtls) {
      //return NextResponse.json({ error: 'No refresh token provided' }, { status: 401 })
      return logoutUser(req)
    }

    // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–æ–∫–µ–Ω–∏ –Ω–∞ API
    const refreshedAPITokens = await fetch(`${req.nextUrl.origin}/api/rest/refreshresttokens`, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
        Cookie: req.headers.get('cookie') || '',
      },
    })

    // **–î–æ–¥–∞—î–º–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è —Ç–∏–ø—É –∫–æ–Ω—Ç–µ–Ω—Ç—É**
    const contentType = refreshedAPITokens.headers.get('content-type') || 'unknown'
    console.log(`üî¥ Refresh token response content-type: ${contentType}`)

    if (!refreshedAPITokens.ok) {
      console.error('üî¥ Refresh token request failed with status:', refreshedAPITokens.status)
      return logoutUser(req)
    }

    // **–ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Å–µ—Ä–≤–µ—Ä —É JSON-—Ñ–æ—Ä–º–∞—Ç—ñ**
    if (!contentType.includes('application/json')) {
      console.error(
        'üî¥ Server did not return JSON, possible error page:',
        await refreshedAPITokens.text()
      )
      return logoutUser(req)
    }

    const refreshTokenData = await refreshedAPITokens.json()
    const newAccessToken = refreshTokenData.newAccessToken
    const newRefreshToken = refreshTokenData.newRefreshToken
    const newEtlsUser = refreshTokenData.newEtlsUser

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ refreshTokenEtls
    const { payload } = await jwtVerify(refreshTokenEtls, ETLS_REFRESH)

    // –ì–µ–Ω–µ—Ä—É—î–º–æ –Ω–æ–≤—ñ —Ç–æ–∫–µ–Ω–∏
    const newAccessTokenEtls = await new SignJWT({ username: payload.username })
      .setProtectedHeader({ alg: 'HS256' })
      .setExpirationTime(Math.floor(Date.now() / 1000) + EXPIRES_IN_ACCESS_ETLS)
      .sign(ETLS_ACCESS)

    const newRefreshTokenEtls = await new SignJWT({ username: payload.username })
      .setProtectedHeader({ alg: 'HS256' })
      .setExpirationTime(Math.floor(Date.now() / 1000) + EXPIRES_IN_REFRESH_ETLS)
      .sign(ETLS_REFRESH)

    // –§–æ—Ä–º—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑ –Ω–æ–≤–∏–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏ + cookies
    const response = NextResponse.json({
      message: 'Tokens refreshed',
      newAccessTokenEtls: newAccessTokenEtls,
      newRefreshTokenEtls: newRefreshTokenEtls,
      newAccessToken: newAccessToken,
      newRefreshToken: newRefreshToken,
      newEtlsUser: newEtlsUser,
    })

    response.headers.set(
      'Set-Cookie',
      [
        `accessTokenEtls=${newAccessTokenEtls}; HttpOnly; Path=/; Max-Age=43200`,
        `refreshTokenEtls=${newRefreshTokenEtls}; HttpOnly; Path=/; Max-Age=43200`,
        `accessToken=${newAccessToken}; HttpOnly; Path=/; Max-Age=43200`,
        `refreshToken=${newRefreshToken}; HttpOnly; Path=/; Max-Age=43200`,
        `etlsUser=${newEtlsUser}; HttpOnly; Path=/; Max-Age=43200`,
      ].join(', ')
    )

    return response
  } catch (error) {
    console.error('Failed to refresh tokens:', error)
    return NextResponse.json({ error: 'Invalid refresh token' }, { status: 401 })
  }
}
```

---

## 2) –ù–æ–≤–∞ –≤–µ—Ä—Å—ñ—è –ø—ñ–¥ App Router

‚úÖ **NEW:** `src/app/api/auth/refreshtoken/route.js`

```js
import { NextResponse } from 'next/server'
import { cookies } from 'next/headers'
import { jwtVerify, SignJWT } from 'jose'

export const runtime = 'edge'

const ETLS_ACCESS = new TextEncoder().encode(process.env.ETLS_ACCESS)
const ETLS_REFRESH = new TextEncoder().encode(process.env.ETLS_REFRESH)

const EXPIRES_IN_ACCESS_ETLS = Number(process.env.ETLS_ACCESS_EXPIRE_TIME || 0)
const EXPIRES_IN_REFRESH_ETLS = Number(process.env.ETLS_REFRESH_EXPIRE_TIME || 0)

const COOKIE_MAX_AGE = 43200 // 12 –≥–æ–¥

function logoutResponse() {
  const res = NextResponse.json({ error: 'Unauthorized' }, { status: 401 })

  const opts = { path: '/', maxAge: 0 }
  res.cookies.set('accessToken', '', opts)
  res.cookies.set('refreshToken', '', opts)
  res.cookies.set('accessTokenEtls', '', opts)
  res.cookies.set('refreshTokenEtls', '', opts)
  res.cookies.set('etlsUser', '', opts)

  return res
}

export async function POST(req) {
  try {
    const cookieStore = cookies()
    const refreshTokenEtls = cookieStore.get('refreshTokenEtls')?.value

    if (!refreshTokenEtls) {
      return logoutResponse()
    }

    // –¢—è–≥–Ω–µ–º–æ refresh —ñ–∑ —Ç–≤–æ–≥–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–≥–æ API (proxy), –ø–µ—Ä–µ–¥–∞—é—á–∏ cookies –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    const origin = new URL(req.url).origin

    const refreshedAPITokens = await fetch(`${origin}/api/rest/refreshresttokens`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Cookie: req.headers.get('cookie') || '',
      },
    })

    const contentType = refreshedAPITokens.headers.get('content-type') || 'unknown'
    console.log(`üî¥ Refresh token response content-type: ${contentType}`)

    if (!refreshedAPITokens.ok) {
      console.error('üî¥ Refresh token request failed with status:', refreshedAPITokens.status)
      return logoutResponse()
    }

    if (!contentType.includes('application/json')) {
      console.error('üî¥ Server did not return JSON, possible error page:', await refreshedAPITokens.text())
      return logoutResponse()
    }

    const refreshTokenData = await refreshedAPITokens.json()
    const newAccessToken = refreshTokenData.newAccessToken
    const newRefreshToken = refreshTokenData.newRefreshToken
    const newEtlsUser = refreshTokenData.newEtlsUser

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ refreshTokenEtls (–≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–≥–æ)
    const { payload } = await jwtVerify(refreshTokenEtls, ETLS_REFRESH)

    const newAccessTokenEtls = await new SignJWT({ username: payload.username })
      .setProtectedHeader({ alg: 'HS256' })
      .setExpirationTime(Math.floor(Date.now() / 1000) + EXPIRES_IN_ACCESS_ETLS)
      .sign(ETLS_ACCESS)

    const newRefreshTokenEtls = await new SignJWT({ username: payload.username })
      .setProtectedHeader({ alg: 'HS256' })
      .setExpirationTime(Math.floor(Date.now() / 1000) + EXPIRES_IN_REFRESH_ETLS)
      .sign(ETLS_REFRESH)

    const response = NextResponse.json({ message: 'Tokens refreshed' })

    const common = {
      httpOnly: true,
      path: '/',
      maxAge: COOKIE_MAX_AGE,
      sameSite: 'lax',
      // secure: true, // –≤ –ø—Ä–æ–¥—ñ
    }

    response.cookies.set('accessTokenEtls', newAccessTokenEtls, common)
    response.cookies.set('refreshTokenEtls', newRefreshTokenEtls, common)
    response.cookies.set('accessToken', newAccessToken, common)
    response.cookies.set('refreshToken', newRefreshToken, common)
    response.cookies.set('etlsUser', newEtlsUser, common)

    return response
  } catch (error) {
    console.error('Failed to refresh tokens:', error)
    return logoutResponse()
  }
}
```

---

## 3) –©–æ —Ç–µ–ø–µ—Ä —Ä–æ–±–∏—Ç–∏ –∑—ñ —Å—Ç–∞—Ä–∏–º `logoutUser`

* –Ø–∫—â–æ —Ü–µ–π `logoutUser` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —â–µ –¥–µ—Å—å (middleware –∞–±–æ —ñ–Ω—à—ñ API) ‚Äî —Ç–æ–¥—ñ –º–∏ –∞–±–æ:

  * –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ –π–æ–≥–æ –≤ `src/shared/auth/logoutResponse.js`, –∞–±–æ
  * —Ä–æ–±–∏–º–æ –æ–∫—Ä–µ–º–∏–π route `/api/auth/logout` —ñ –≤—Å—é–¥–∏ —Ä–µ–¥—ñ—Ä–µ–∫—Ç–∏–º–æ —Ç—É–¥–∏.

–ê–ª–µ –¥–ª—è —Ü—å–æ–≥–æ —Ñ–∞–π–ª—É –≤–∂–µ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ª–æ–∫–∞–ª—å–Ω–æ—ó `logoutResponse()`.

---

–ö–∏–¥–∞–π –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ñ–∞–π–ª –∑—ñ —Å—Ç–∞—Ä–æ—ó auth-–≥—ñ–ª–∫–∏ (`utils/auth`, `refreshresttokens`, `customfetch`, middleware.js) ‚Äî —ñ –º–∏ –¥–æ–≤–µ–¥–µ–º–æ –≤–µ—Å—å auth-–∫–æ–Ω—Ç—É—Ä –¥–æ –æ–¥–Ω—ñ—î—ó —á–∏—Å—Ç–æ—ó —Å—Ö–µ–º–∏ –±–µ–∑ –¥—É–±–ª—é–≤–∞–Ω–Ω—è –∫–æ–¥—É.
