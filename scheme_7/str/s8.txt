–û–∫, —Ü–µ –∫–ª—é—á–æ–≤–∏–π —Ñ–∞–π–ª ‚Äî —Ç–≤—ñ–π ‚Äúproxy fetch‚Äù –∑ –∞–≤—Ç–æ-—Ä–µ—Ñ—Ä–µ—à–µ–º.

### ‚úÖ –ö—É–¥–∏ –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ

–ó –æ–≥–ª—è–¥—É –Ω–∞ —Ç–≤–æ—é –Ω–æ–≤—É –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É (—Ç–∏ –≤–∂–µ –∑–≥–∞–¥—É–≤–∞–≤ `api/rest/customfetch.js` —è–∫ –ø—Ä–æ–∫—Å—ñ), —è –± –∑—Ä–æ–±–∏–≤ —Ç–∞–∫:

1. **–û—Å–Ω–æ–≤–Ω–∏–π (–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π) –º–∞—Ä—à—Ä—É—Ç**
   ‚úÖ **NEW:** `src/app/api/rest/customfetch/route.js`

2. **–°—É–º—ñ—Å–Ω—ñ—Å—Ç—å –∑—ñ —Å—Ç–∞—Ä–∏–º —à–ª—è—Ö–æ–º (—â–æ–± –Ω—ñ—á–æ–≥–æ –Ω–µ –≤–ø–∞–ª–æ, —è–∫—â–æ –¥–µ—Å—å —â–µ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è `/api/auth/customfetch`)**
   ‚úÖ **NEW:** `src/app/api/auth/customfetch/route.js` (—Ç–æ–Ω–∫–∏–π –ø—Ä–æ–∫—Å—ñ –Ω–∞ `/api/rest/customfetch`)

–ù–∏–∂—á–µ ‚Äî –≥–æ—Ç–æ–≤—ñ —Ñ–∞–π–ª–∏.

---

## 1) NEW: `src/app/api/rest/customfetch/route.js`

```js
import { NextResponse } from 'next/server'
import { cookies } from 'next/headers'

export const runtime = 'edge'

const REMOTE_API = process.env.MAIN_API_URL
const COOKIE_MAX_AGE = 43200 // 12 –≥–æ–¥

function logoutResponse() {
  const res = NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  const opts = { path: '/', maxAge: 0 }
  res.cookies.set('accessToken', '', opts)
  res.cookies.set('refreshToken', '', opts)
  res.cookies.set('accessTokenEtls', '', opts)
  res.cookies.set('refreshTokenEtls', '', opts)
  res.cookies.set('etlsUser', '', opts)
  res.cookies.set('refreshingToken', '', opts)
  return res
}

async function callRefreshToken(req) {
  const origin = new URL(req.url).origin

  const refreshed = await fetch(`${origin}/api/auth/refreshtoken`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Cookie: req.headers.get('cookie') || '',
    },
  })

  if (!refreshed.ok) return null

  // –æ—á—ñ–∫—É—î–º–æ JSON –∑ –ø–æ–ª—è–º–∏: newAccessToken, newRefreshToken, newAccessTokenEtls, newRefreshTokenEtls, newEtlsUser
  const data = await refreshed.json()
  return data
}

export async function POST(req) {
  try {
    const { url, options = {} } = await req.json()
    if (!url) {
      return NextResponse.json({ error: 'No url provided' }, { status: 400 })
    }

    // —á–∏—Ç–∞—î–º–æ cookies (–≤—Ö—ñ–¥–Ω—ñ)
    const cookieStore = cookies()
    let accessToken = cookieStore.get('accessToken')?.value
    let refreshToken = cookieStore.get('refreshToken')?.value
    let accessTokenEtls = cookieStore.get('accessTokenEtls')?.value
    let refreshTokenEtls = cookieStore.get('refreshTokenEtls')?.value
    let etlsUser = cookieStore.get('etlsUser')?.value
    const refreshingToken = cookieStore.get('refreshingToken')?.value // "1" —è–∫—â–æ —Ö—Ç–æ—Å—å –≤–∂–µ –æ–Ω–æ–≤–ª—é—î

    // —è–∫—â–æ –≤–∂–µ —Ç—Ä–∏–≤–∞—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è ‚Äî —Ç—Ä–æ—Ö–∏ —á–µ–∫–∞—î–º–æ
    if (refreshingToken === '1') {
      console.log('‚è≥ Waiting for token refresh in customFetch...')
      await new Promise((r) => setTimeout(r, 2000))
    }

    // —è–∫—â–æ accessToken –≤—ñ–¥—Å—É—Ç–Ω—ñ–π, –∞–ª–µ —î refreshToken ‚Äî –ø—Ä–æ–±—É—î–º–æ –æ–Ω–æ–≤–∏—Ç–∏
    let didRefresh = false
    if (!accessToken) {
      if (!refreshToken) return logoutResponse()

      console.log('üîÑ Access token missing, trying to refresh...')
      const refreshed = await callRefreshToken(req)
      if (!refreshed) return logoutResponse()

      accessToken = refreshed.newAccessToken
      refreshToken = refreshed.newRefreshToken
      accessTokenEtls = refreshed.newAccessTokenEtls
      refreshTokenEtls = refreshed.newRefreshTokenEtls
      etlsUser = refreshed.newEtlsUser
      didRefresh = true
    }

    // —Ñ–æ—Ä–º—É—î–º–æ –∑–∞–ø–∏—Ç –¥–æ REMOTE_API
    const method = (options.method || 'GET').toUpperCase()

    const fetchOptions = {
      method,
      headers: {
        Authorization: `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
        ...(options.headers || {}),
      },
    }

    if (!['GET', 'DELETE'].includes(method)) {
      fetchOptions.body = JSON.stringify(options.body || {})
    }

    let response = await fetch(`${REMOTE_API}${url}`, fetchOptions)

    // —è–∫—â–æ 401 ‚Äî –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–æ–±—É—î–º–æ –æ–Ω–æ–≤–∏—Ç–∏ —Ç–æ–∫–µ–Ω–∏ –π –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏
    if (response.status === 401) {
      console.warn('‚ö†Ô∏è Received 401, trying refresh & retry...')

      // –ø–æ–∑–Ω–∞—á–∞—î–º–æ, —â–æ –ø–æ—á–∞–ª–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è (–¥–ª—è –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ —É –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö —Ç–∏–∫–∞—Ö)
      const refreshed = await callRefreshToken(req)
      if (!refreshed) return logoutResponse()

      accessToken = refreshed.newAccessToken
      refreshToken = refreshed.newRefreshToken
      accessTokenEtls = refreshed.newAccessTokenEtls
      refreshTokenEtls = refreshed.newRefreshTokenEtls
      etlsUser = refreshed.newEtlsUser
      didRefresh = true

      fetchOptions.headers.Authorization = `Bearer ${accessToken}`
      response = await fetch(`${REMOTE_API}${url}`, fetchOptions)

      if (response.status === 401) {
        return logoutResponse()
      }
    }

    // –ø—Ä–æ–±—É—î–º–æ –≤—ñ–¥–¥–∞—Ç–∏ JSON (—è–∫ —É —Ç–≤–æ—î–º—É –∫–æ–¥—ñ)
    const resultJson = await response.json()
    const out = NextResponse.json(resultJson, { status: response.status })

    // –æ–Ω–æ–≤–ª—é—î–º–æ cookies, —è–∫—â–æ –±—É–ª–∏ –∑–º—ñ–Ω–∏
    if (didRefresh) {
      const common = {
        httpOnly: true,
        path: '/',
        maxAge: COOKIE_MAX_AGE,
        sameSite: 'lax',
        // secure: true, // –≤ –ø—Ä–æ–¥—ñ
      }

      out.cookies.set('accessToken', accessToken, common)
      out.cookies.set('refreshToken', refreshToken, common)
      out.cookies.set('accessTokenEtls', accessTokenEtls, common)
      out.cookies.set('refreshTokenEtls', refreshTokenEtls, common)
      out.cookies.set('etlsUser', etlsUser, common)

      // –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –ø—Ä–∞–ø–æ—Ä–µ—Ü—å
      out.cookies.set('refreshingToken', '', { path: '/', maxAge: 0 })
    }

    return out
  } catch (error) {
    console.error('‚ùå Error in customFetch:', error)
    return NextResponse.json({ error: 'Request failed' }, { status: 500 })
  }
}
```

> ‚ö†Ô∏è –ü—Ä–∏–º—ñ—Ç–∫–∞: —Ç–≤—ñ–π —Å—Ç–∞—Ä–∏–π –º–µ—Ö–∞–Ω—ñ–∑–º `refreshingToken=1` ‚Äú–≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ç–æ–≥–æ –∂ –∑–∞–ø–∏—Ç—É‚Äù –Ω–µ –¥–æ–ø–æ–º–∞–≥–∞—î, –±–æ cookie –±–∞—á–∞—Ç—å —ñ–Ω—à—ñ –∑–∞–ø–∏—Ç–∏ **–ª–∏—à–µ –ø—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ø–æ–≤–µ—Ä–Ω—É–ª–∞—Å—å**. –ê–ª–µ —è–∫ ‚Äú–ø—Ä–∞–ø–æ—Ä–µ—Ü—å –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω—ñ –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ –∑–∞–ø–∏—Ç–∏‚Äù ‚Äî –º–æ–∂–µ —á–∞—Å—Ç–∫–æ–≤–æ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏. –Ø –∑–∞–ª–∏—à–∏–≤ –ª–æ–≥—ñ–∫—É –∞–∫—É—Ä–∞—Ç–Ω–æ.

---

## 2) NEW: –ø—Ä–æ–∫—Å—ñ –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ `src/app/api/auth/customfetch/route.js`

–Ø–∫—â–æ –¥–µ—Å—å –Ω–∞ —Ñ—Ä–æ–Ω—Ç—ñ —â–µ —î –≤–∏–∫–ª–∏–∫–∏ `/api/auth/customfetch`, —Ç–æ –∑—Ä–æ–±–∏ —Ç–æ–Ω–∫–∏–π –ø—Ä–æ–∫—Å—ñ:

```js
import { NextResponse } from 'next/server'

export const runtime = 'edge'

export async function POST(req) {
  const origin = new URL(req.url).origin

  const res = await fetch(`${origin}/api/rest/customfetch`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Cookie: req.headers.get('cookie') || '',
    },
    body: await req.text(),
  })

  // –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∫–∏–¥—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
  const contentType = res.headers.get('content-type') || ''
  const body = contentType.includes('application/json') ? await res.json() : await res.text()

  const out = NextResponse.json(
    typeof body === 'string' ? { body } : body,
    { status: res.status }
  )

  // –≤–∞–∂–ª–∏–≤–æ: cookies, —è–∫—ñ –≤–∏—Å—Ç–∞–≤–∏–≤ /api/rest/customfetch, –±—Ä–∞—É–∑–µ—Ä –æ—Ç—Ä–∏–º–∞—î –ª–∏—à–µ –∑ —Ç—ñ—î—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.
  // –¶–µ–π –ø—Ä–æ–∫—Å—ñ —ó—Ö –Ω–µ "–ø–µ—Ä–µ–ø—Ä–∏—Å–≤–æ—é—î". –¢–æ–º—É –∫—Ä–∞—â–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–∏ –Ω–∞ /api/rest/customfetch.
  return out
}
```

–Ø–∫—â–æ —Ö–æ—á–µ—à **100% —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å**, —Ç–æ–¥—ñ —Ü–µ–π –ø—Ä–æ–∫—Å—ñ –º–∞—î **–Ω–µ NextResponse.json —Ä–æ–±–∏—Ç–∏**, –∞ –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ ‚Äúraw Response‚Äù –∑ —É—Å—ñ–º–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ (–≤–∫–ª—é—á–Ω–æ `set-cookie`). –ê–ª–µ –≤ edge —Ü–µ —Ç—Ä–µ–±–∞ —Ä–æ–±–∏—Ç–∏ –∞–∫—É—Ä–∞—Ç–Ω–æ ‚Äî —Å–∫–∞–∂–∏, —ñ —è –¥–∞–º —Ç–æ—á–Ω—É –≤–µ—Ä—Å—ñ—é.

---

## 3) –ü—ñ–¥—Å—É–º–æ–∫ –º—ñ–≥—Ä–∞—Ü—ñ—ó

* **OLD:** `pages/api/auth/customfetch.js`
* **NEW (–æ—Å–Ω–æ–≤–Ω–∏–π):** `src/app/api/rest/customfetch/route.js`
* **NEW (—Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å):** `src/app/api/auth/customfetch/route.js` (–∑–∞ –ø–æ—Ç—Ä–µ–±–∏)

---

–ö–∏–¥–∞–π –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ñ–∞–π–ª. –Ø –± –¥–∞–ª—ñ –≤–∑—è–≤ –∞–±–æ **`utils/auth` (logoutUser)**, –∞–±–æ **`api/rest/refreshresttokens`**, –±–æ –≤–æ–Ω–∏ –∑–∞—Ä–∞–∑ –≤–ø–ª–∏–≤–∞—é—Ç—å –Ω–∞ –≤–µ—Å—å –ª–∞–Ω—Ü—é–∂–æ–∫.
