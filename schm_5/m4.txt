–¢–∞–∫, –ø–æ —Ç–≤–æ—î–º—É –∫–æ–¥—É –≤–∏–¥–Ω–æ **–¥–≤—ñ –ø—Ä–∏—á–∏–Ω–∏** –ø—Ä–æ–±–ª–µ–º:

1. **Grid –Ω–µ ‚Äú—Å–∫–µ–π–ª–∏—Ç—å—Å—è‚Äù –ø—Ä–∏ zoom**, –±–æ —Ç–∏ –∑–∞—Ä–∞–∑ –º–∞–ª—é—î—à –≥—Ä—ñ–¥ —è–∫ ‚Äú–µ–∫—Ä–∞–Ω–Ω–∏–π‚Äù (—á–µ—Ä–µ–∑ `scale/offsetX/offsetY`), –∞–ª–µ —Ü—ñ –∑–Ω–∞—á–µ–Ω–Ω—è, –π–º–æ–≤—ñ—Ä–Ω–æ, **–Ω–µ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —ñ–∑ zoom/pan**, –∞–±–æ —Ç–∏ –∑—É–º—É—î—à **—ñ–Ω—à–∏–π layer/group**, –∞ GridLayer ‚Äî –≤ –æ–∫—Ä–µ–º–æ–º—É `<Layer>` –±–µ–∑ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ–π.

2. **–ü—ñ–¥–ª–∞–≥—É–≤–∞–Ω–Ω—è –ø—Ä–∏ drag** ‚Äî –º–∞–π–∂–µ –∑–∞–≤–∂–¥–∏ —á–µ—Ä–µ–∑ —Ç–µ, —â–æ –≥—Ä—ñ–¥ —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ **–±–∞–≥–∞—Ç—å–æ—Ö `<Line>`**. –ù–∞–≤—ñ—Ç—å –∑ `listening={false}` —Å–æ—Ç–Ω—ñ –ª—ñ–Ω—ñ–π = –≤–∞–∂–∫–æ, –æ—Å–æ–±–ª–∏–≤–æ —è–∫—â–æ React —á–∞—Å—Ç—ñ—à–µ –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä—é—î GridLayer.

–ù–∏–∂—á–µ ‚Äî —â–æ –≤ —Ç–µ–±–µ –¥–æ–±—Ä–µ, —â–æ —Ç—Ä–µ–±–∞ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏, —ñ —è–∫ –∑—Ä–æ–±–∏—Ç–∏ ‚Äú—è–∫ —É Visio‚Äù –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ.

---

## 1) –û—Ü—ñ–Ω–∏ —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤

–¢–≤–æ—è —ñ–¥–µ—è **features/page-name + shared** ‚Äî –æ–∫. –ê–ª–µ —î –ø–∞—Ä—É –ø—Ä–∞–≤–æ–∫:

### ‚úÖ –î–æ–±—Ä–µ

* `GridLayer` —ñ `GuidesLayer` —è–∫ UI-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ –≤ `features/.../ui/canvas/` ‚Äî –Ω–æ—Ä–º.
* `buildGridLines` / `computeSnap` –≤ `shared/konva/...` ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω–æ (—Ü–µ —á–∏—Å—Ç–∞ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞).

### ‚ö†Ô∏è –©–æ –± —è –ø–æ–ø—Ä–∞–≤–∏–≤

* **Hooks** (`useGrid`, `useGuidesSnap`) –∫—Ä–∞—â–µ —Ç—Ä–∏–º–∞—Ç–∏ **–Ω–µ** –≤ `shared/konva/grid/`, –∞ –≤:

  * `shared/hooks/konva/useGrid.js` (—è–∫—â–æ –∑–∞–≥–∞–ª—å–Ω—ñ)
  * –∞–±–æ `features/diagram/hooks/useGrid.js` (—è–∫—â–æ —Ç—ñ–ª—å–∫–∏ –¥–ª—è diagram)

–ë–æ `shared/konva/...` = –±–∞–∂–∞–Ω–æ **–±–µ–∑ React** (—á–∏—Å—Ç—ñ —Ñ—É–Ω–∫—Ü—ñ—ó).

### ‚ùó –î—É–∂–µ –≤–∞–∂–ª–∏–≤–æ

–£ —Ç–≤–æ—î–º—É —à–º–∞—Ç–∫—É –∫–æ–¥—É –≤ –æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—ñ –π–¥–µ —ñ hook, —ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, —ñ –¥–≤—ñ—á—ñ `use client`.
–†–æ–∑–Ω–µ—Å–∏:

* `app/diagram/hooks/useGrid.js` ‚Üí —Ç—ñ–ª—å–∫–∏ hook
* `.../ui/canvas/GridLayer.js` ‚Üí —Ç—ñ–ª—å–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

---

## 2) –ß–æ–º—É grid –Ω–µ –ø—Ä–∞—Ü—é—î –ø—Ä–∏ zoom (—ñ —è–∫ –∑—Ä–æ–±–∏—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ)

### –ü—Ä–∞–≤–∏–ª–æ Konva:

**–Ø–∫—â–æ zoom/pan –∑–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç—å—Å—è –¥–æ world-layer**, –∞ grid –≤ –æ–∫—Ä–µ–º–æ–º—É layer ‚Äî –≤—ñ–Ω –Ω–µ –±—É–¥–µ –º–∞—Å—à—Ç–∞–±—É–≤–∞—Ç–∏—Å—å, –¥–æ–∫–∏ —Ç–∏:

* –∞–±–æ **–º–∞–ª—é—î—à –π–æ–≥–æ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º viewport** (scale/offset)
* –∞–±–æ **—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î—à transform** grid-layer –∑ world-layer
* –∞–±–æ **–º–∞–ª—é—î—à –≥—Ä—ñ–¥ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ world-layer** (–Ω–∞–π–∫—Ä–∞—â–µ)

### –ù–∞–π–∫—Ä–∞—â–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é): **Grid –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ world-layer**

–¢–æ–¥—ñ grid –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –º–∞—Å—à—Ç–∞–±—É—î—Ç—å—Å—è —ñ —Ä—É—Ö–∞—î—Ç—å—Å—è —Ä–∞–∑–æ–º –∑—ñ —Å—Ö–µ–º–æ—é, —ñ —Ç–æ–±—ñ –Ω–µ —Ç—Ä–µ–±–∞ `scale/offsetX/offsetY` —É GridLayer –≤–∑–∞–≥–∞–ª—ñ.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ Stage:**

```jsx
<Stage ...>
  <Layer ref={worldLayerRef}>
    <GridLayer visible={gridVisible} />     {/* listening=false */}
    <GuidesLayer guides={guides} />         {/* listening=false */}
    <ElementsLayer />                       {/* –µ–ª–µ–º–µ–Ω—Ç–∏ */}
  </Layer>
</Stage>
```

üëâ –£ —Ç–∞–∫–æ–º—É –ø—ñ–¥—Ö–æ–¥—ñ **grid –∑–∞–≤–∂–¥–∏ scale**, –±–æ –≤—ñ–Ω —É —Ç–æ–º—É –∂ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ, —â–æ –π –µ–ª–µ–º–µ–Ω—Ç–∏.

---

## 3) –ß–æ–º—É ‚Äú–ø—Ä–∏–≥–∞–ª—å–º–æ–≤—É—î‚Äù –ø—Ä–∏ –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—ñ

–ù–∞–≤—ñ—Ç—å —è–∫—â–æ grid –Ω–µ –ø–µ—Ä–µ–±—É–¥–æ–≤—É—î—Ç—å—Å—è, **—Å–æ—Ç–Ω—ñ `<Line/>`** = –¥–æ—Ä–æ–≥–æ.

### –ù–∞–π—Å–∏–ª—å–Ω—ñ—à–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è:

**–ù–µ —Ä–µ–Ω–¥–µ—Ä–∏—Ç–∏ —Å–æ—Ç–Ω—ñ Line-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤.**
–ó–∞–º—ñ—Å—Ç—å —Ü—å–æ–≥–æ ‚Äî **–æ–¥–∏–Ω `<Shape sceneFunc>`**, —è–∫–∏–π –º–∞–ª—é—î –≥—Ä—ñ–¥ —Å–∞–º (–æ–¥–Ω–∞ –Ω–æ–¥–∞, –æ–¥–∏–Ω draw-call).

–û—Å—å –≥–æ—Ç–æ–≤–∏–π GridLayer, —è–∫–∏–π:

* –º–∞–ª—é—î –≥—Ä—ñ–¥ **–≤ –æ–¥–Ω–æ–º—É Shape**
* –ø—Ä–∞—Ü—é—î **–¥—É–∂–µ —à–≤–∏–¥–∫–æ**
* —è–∫—â–æ —Ç–∏ –ø–æ–º—ñ—Å—Ç–∏—à –π–æ–≥–æ –≤ world-layer ‚Äî –≤—ñ–Ω –±—É–¥–µ —ñ **zoom/pan friendly**.

```jsx
"use client";
import React from "react";
import { Group, Shape } from "react-konva";

export default function GridLayer({
  visible,
  width = 4000,   // ‚Äú–ø–ª–æ—â–∞ —Å–≤—ñ—Ç—É‚Äù (–º–æ–∂–µ—à –∑—Ä–æ–±–∏—Ç–∏ –±—ñ–ª—å—à–µ)
  height = 4000,
  gridSize = 40,
  subDiv = 4,
}) {
  if (!visible) return null;

  const minor = gridSize / subDiv;

  return (
    <Group listening={false}>
      <Shape
        listening={false}
        perfectDrawEnabled={false}
        sceneFunc={(ctx, shape) => {
          // –º–∞–ª—é—î–º–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—ñ
          ctx.beginPath();
          for (let x = 0; x <= width; x += minor) {
            ctx.moveTo(x, 0);
            ctx.lineTo(x, height);
          }
          // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—ñ
          for (let y = 0; y <= height; y += minor) {
            ctx.moveTo(0, y);
            ctx.lineTo(width, y);
          }
          ctx.strokeStyle = "#e9e9e9";
          ctx.lineWidth = 0.5;
          ctx.stroke();

          // –æ—Å–Ω–æ–≤–Ω—ñ (major) –ª—ñ–Ω—ñ—ó
          ctx.beginPath();
          for (let x = 0; x <= width; x += gridSize) {
            ctx.moveTo(x, 0);
            ctx.lineTo(x, height);
          }
          for (let y = 0; y <= height; y += gridSize) {
            ctx.moveTo(0, y);
            ctx.lineTo(width, y);
          }
          ctx.strokeStyle = "#cfcfcf";
          ctx.lineWidth = 1;
          ctx.stroke();

          ctx.fillStrokeShape(shape);
        }}
      />
    </Group>
  );
}
```

### –ü–µ—Ä–µ–≤–∞–≥–∏ —Ü—å–æ–≥–æ –ø—ñ–¥—Ö–æ–¥—É

* –∑–∞–º—ñ—Å—Ç—å **300‚Äì1200 Line** ‚Üí **1 Shape**
* drag —Å—Ç–∞—î –º–∞–π–∂–µ —è–∫ –±–µ–∑ grid

---

## 4) –Ø–∫—â–æ —Ç–∏ —Ö–æ—á–µ—à –ª–∏—à–∏—Ç–∏ buildGridLines + Line (–º–æ–∂–Ω–∞, –∞–ª–µ –º–µ–Ω—à —à–≤–∏–¥–∫–æ)

–¢–æ–¥—ñ –∫—Ä–∏—Ç–∏—á–Ω–æ:

* grid –º–∞—î **–ø–µ—Ä–µ–±—É–¥–æ–≤—É–≤–∞—Ç–∏—Å—å —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ zoom/pan/resize**, –ù–ï –ø—Ä–∏ drag –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
* –ø–µ—Ä–µ–≤—ñ—Ä, —â–æ `scale/offsetX/offsetY` –Ω–µ –∑–º—ñ–Ω—é—é—Ç—å—Å—è –ø—ñ–¥ —á–∞—Å drag

–ù–∞–π—á–∞—Å—Ç—ñ—à–∞ –ø–æ–º–∏–ª–∫–∞ ‚Äî —Ç–∏ –∑–±–µ—Ä—ñ–≥–∞—î—à viewport –≤ React state —ñ –æ–Ω–æ–≤–ª—é—î—à –π–æ–≥–æ –¥—É–∂–µ —á–∞—Å—Ç–æ, —â–æ —Ç—è–≥–Ω–µ —Ä–µ—Ä–µ–Ω–¥–µ—Ä GridLayer.

---

## 5) –í—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ ‚Äú—Ü–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ —á–∏ –Ω—ñ?‚Äù

* **–õ–µ–¥—å –≤—ñ–¥—á—É—Ç–Ω–µ** –ø–∞–¥—ñ–Ω–Ω—è FPS ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω–æ (grid –∑–∞–≤–∂–¥–∏ –∫–æ—à—Ç—É—î —Ä–µ—Å—É—Ä—Å—ñ–≤).
* **–ü–æ–º—ñ—Ç–Ω—ñ —Ä–∏–≤–∫–∏ –ø—Ä–∏ drag** ‚Äî –Ω–µ –Ω–æ—Ä–º–∞ ‚Üí —Ü–µ –æ–∑–Ω–∞–∫–∞, —â–æ:

  * –∞–±–æ grid —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ –±–∞–≥–∞—Ç—å–æ—Ö –Ω–æ–¥ (Line),
  * –∞–±–æ grid –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä—é—î—Ç—å—Å—è –Ω–∞–¥—Ç–æ —á–∞—Å—Ç–æ.

---

## –©–æ —è —Ä–∞–¥–∂—É –∑—Ä–æ–±–∏—Ç–∏ –ø—Ä—è–º–æ –∑–∞—Ä–∞–∑ (–±–µ–∑ –≤–µ–ª–∏–∫–∏—Ö –ø–µ—Ä–µ—Ä–æ–±–æ–∫)

1. **–ü–µ—Ä–µ–º—ñ—Å—Ç–∏ GridLayer –≤—Å–µ—Ä–µ–¥–∏–Ω—É world-layer**, —è–∫–∏–π –∑—É–º–∏—Ç—å—Å—è/–ø–∞–Ω–∏—Ç—å—Å—è.
2. –ó–∞–º—ñ–Ω–∏—Ç–∏ grid –∑ `Line[]` –Ω–∞ **–æ–¥–∏–Ω Shape** (–∫–æ–¥ –≤–∏—â–µ).
3. –ü–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ grid **–Ω–µ –∑–∞–ª–µ–∂–∏—Ç—å** –≤—ñ–¥ –ø–æ–∑–∏—Ü—ñ–π –µ–ª–µ–º–µ–Ω—Ç—ñ–≤.

---

–Ø–∫—â–æ —Å–∫–∏–Ω–µ—à 10‚Äì20 —Ä—è–¥–∫—ñ–≤, –¥–µ —É —Ç–µ–±–µ —Ä–æ–±–∏—Ç—å—Å—è zoom/pan (–Ω–∞ layer —á–∏ –Ω–∞ stage) —ñ —è–∫ —Ç–∏ –∑–∞—Ä–∞–∑ –≤—Å—Ç–∞–≤–ª—è—î—à `GridLayer` –≤ –¥–µ—Ä–µ–≤–æ Konva ‚Äî —è —Å–∫–∞–∂—É —Ç–æ—á–Ω–æ, —è–∫–∏–π —ñ–∑ –¥–≤–æ—Ö –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ —Ç–æ–±—ñ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å:

* **–≤—Å–µ—Ä–µ–¥–∏–Ω—ñ world-layer** (–∫—Ä–∞—â–µ)
* –∞–±–æ **—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ transform** –¥–≤–æ—Ö layer‚Äô—ñ–≤ (—è–∫—â–æ –¥—É–∂–µ —Ç—Ä–µ–±–∞ –æ–∫—Ä–µ–º–æ).
