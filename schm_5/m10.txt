–û–∫, —Ç–æ–¥—ñ —Ä–æ–±–∏–º–æ **—ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—é –≤ GraphLibrary + –ø–æ–≤–Ω–∏–π —Ü–∏–∫–ª ‚Äú–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–µ –º–µ–Ω—é ‚Üí –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –ø—ñ–¥–ø–∏—Å—É ‚Üí —Ä–µ–Ω–¥–µ—Ä‚Äù**. –ù–∏–∂—á–µ ‚Äî –≥–æ—Ç–æ–≤—ñ —Ñ–∞–π–ª–∏/–≤—Å—Ç–∞–≤–∫–∏.

---

## 1) –î–æ–¥–∞—î–º–æ shared-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø—ñ–¥–ø–∏—Å—É

üìÅ `app/diagram/components/LabelText.js`

```jsx
"use client";
import React, { useMemo } from "react";
import { Text } from "react-konva";

const WEIGHT_TO_NUM = {
  light: 300,
  regular: 400,
  medium: 500,
  bold: 700,
};

function clamp(n, a, b) {
  return Math.max(a, Math.min(b, n));
}

export default function LabelText({
  label,
  elementRect, // { x:0,y:0,width,height } —É –ª–æ–∫–∞–ª—å–Ω–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö –≥—Ä—É–ø–∏
}) {
  const cfg = label || {};
  const visible = !!cfg.visible;
  if (!visible) return null;

  const text = (cfg.text ?? "").toString();
  if (!text.trim()) return null;

  const position = cfg.position || "top"; // top|bottom|left|right
  const offset = Number.isFinite(cfg.offset) ? cfg.offset : 6;
  const fontSize = clamp(Number(cfg.fontSize ?? 14), 6, 72);
  const color = cfg.color || "#000";
  const fontFamily = cfg.fontFamily || "Inter";
  const weightKey = cfg.fontWeight || "regular";

  const fontStyle = weightKey === "bold" ? "bold" : "normal";
  const fontVariant = WEIGHT_TO_NUM[weightKey] || 400; // –¥–ª—è –ª–æ–≥—ñ–∫–∏/–º–µ—Ç–∞–¥–∞–Ω–∏—Ö

  const { x, y, rotation, align, offsetX, offsetY } = useMemo(() => {
    const w = elementRect?.width ?? 0;
    const h = elementRect?.height ?? 0;

    // –ü–æ–∑–∏—Ü—ñ–æ–Ω—É—î–º–æ –≤—ñ–¥–Ω–æ—Å–Ω–æ –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫–∞ –µ–ª–µ–º–µ–Ω—Ç–∞ –≤ –º–µ–∂–∞—Ö Group
    // –î–ª—è top/bottom —Ü–µ–Ω—Ç—Ä—É—î–º–æ –ø–æ X, –¥–ª—è left/right —Ü–µ–Ω—Ç—Ä—É—î–º–æ –ø–æ Y.
    if (position === "top") {
      return {
        x: w / 2,
        y: -offset,
        rotation: 0,
        align: "center",
        offsetX: 0,
        offsetY: 0,
      };
    }
    if (position === "bottom") {
      return {
        x: w / 2,
        y: h + offset,
        rotation: 0,
        align: "center",
        offsetX: 0,
        offsetY: 0,
      };
    }
    if (position === "left") {
      return {
        x: -offset,
        y: h / 2,
        rotation: -90,
        align: "center",
        offsetX: 0,
        offsetY: 0,
      };
    }
    // right
    return {
      x: w + offset,
      y: h / 2,
      rotation: 90,
      align: "center",
      offsetX: 0,
      offsetY: 0,
    };
  }, [position, offset, elementRect]);

  return (
    <Text
      text={text}
      x={x}
      y={y}
      rotation={rotation}
      fill={color}
      fontSize={fontSize}
      fontFamily={fontFamily}
      fontStyle={fontStyle}
      // –≤–∞–∂–ª–∏–≤–æ: –Ω–µ –∑–∞–≤–∞–∂–∞—î selection/drag
      listening={false}
      align={align}
      verticalAlign="middle"
      // keep for future, —è–∫—â–æ –±—É–¥–µ—à –¥–æ–¥–∞–≤–∞—Ç–∏ –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è/–≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è
      data-font-weight={fontVariant}
      offsetX={offsetX}
      offsetY={offsetY}
    />
  );
}
```

> **–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∏–π –ø—ñ–¥–ø–∏—Å** ‚Äî —Å–∞–º–µ `rotation: ¬±90`, –Ω–µ ‚Äú–ª—ñ—Ç–µ—Ä–∞ –ø—ñ–¥ –ª—ñ—Ç–µ—Ä–æ—é‚Äù.

---

## 2) –í–Ω–æ—Å–∏–º–æ label —É –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π —Å—Ç–∞–Ω –µ–ª–µ–º–µ–Ω—Ç–∞

–ö–æ–ª–∏ —Å—Ç–≤–æ—Ä—é—î—à –±—É–¥—å-—è–∫–∏–π –µ–ª–µ–º–µ–Ω—Ç (rect/circle/‚Ä¶), –¥–æ–¥–∞–≤–∞–π –¥–µ—Ñ–æ–ª—Ç:

```js
label: {
  text: "–ù–∞–∑–≤–∞",
  visible: true,
  position: "top",
  fontSize: 14,
  fontWeight: "regular", // light|regular|medium|bold
  fontFamily: "Inter",
  color: "#000",
  offset: 6,
}
```

---

## 3) –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –ø—ñ–¥–ø–∏—Å —É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏

### Rect

üìÅ `app/components/graph/Rect.js` (–∞–±–æ —Ç–≤—ñ–π —à–ª—è—Ö)

```jsx
"use client";
import React from "react";
import { Group, Rect } from "react-konva";
import LabelText from "@/app/diagram/components/LabelText";

export default function RectElement({ el, onContextMenu, onClickEl, onDragEnd }) {
  return (
    <Group
      x={el.x}
      y={el.y}
      draggable
      onClick={() => onClickEl?.(el.id)}
      onDragEnd={(e) => onDragEnd?.(el.id, e)}
      onContextMenu={(e) => onContextMenu?.(e, el)}
    >
      <Rect
        x={0}
        y={0}
        width={el.width}
        height={el.height}
        fill={el.fill}
        stroke={el.stroke}
        strokeWidth={el.strokeWidth}
      />

      <LabelText
        label={el.label}
        elementRect={{ x: 0, y: 0, width: el.width, height: el.height }}
      />
    </Group>
  );
}
```

### Circle (–≤–∞–∂–ª–∏–≤–æ: —Ç—Ä–µ–±–∞ ‚Äúbounding box‚Äù)

üìÅ `app/components/graph/Circle.js`

```jsx
"use client";
import React from "react";
import { Group, Circle } from "react-konva";
import LabelText from "@/app/diagram/components/LabelText";

export default function CircleElement({ el, onContextMenu, onClickEl, onDragEnd }) {
  const r = el.radius || 20;
  const w = r * 2;
  const h = r * 2;

  return (
    <Group
      x={el.x}
      y={el.y}
      draggable
      onClick={() => onClickEl?.(el.id)}
      onDragEnd={(e) => onDragEnd?.(el.id, e)}
      onContextMenu={(e) => onContextMenu?.(e, el)}
    >
      <Circle x={r} y={r} radius={r} fill={el.fill} stroke={el.stroke} strokeWidth={el.strokeWidth} />

      <LabelText
        label={el.label}
        elementRect={{ x: 0, y: 0, width: w, height: h }}
      />
    </Group>
  );
}
```

---

## 4) –î–æ–¥–∞—î–º–æ ‚ÄúText (–ø—ñ–¥–ø–∏—Å –µ–ª–µ–º–µ–Ω—Ç–∞)‚Äù —è–∫ —Ç–∏–ø —É GraphLibrary

üìÅ `app/components/graph/index.js`

```js
import RectElement from "./Rect";
import CircleElement from "./Circle";
import TextLabelElement from "./TextLabelElement"; // ‚¨ÖÔ∏è –Ω–æ–≤–∏–π

const GraphLibrary = {
  rect: RectElement,
  circle: CircleElement,
  label: TextLabelElement, // ‚¨ÖÔ∏è —è–∫—â–æ —Ö–æ—á–µ—à –æ–∫—Ä–µ–º–∏–π –µ–ª–µ–º–µ–Ω—Ç-–ø—ñ–¥–ø–∏—Å (–Ω–µ –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ)
};

export default GraphLibrary;
```

‚ö†Ô∏è –Ø —Ä–µ–∫–æ–º–µ–Ω–¥—É—é **–ù–ï —Ä–æ–±–∏—Ç–∏ –ø—ñ–¥–ø–∏—Å –æ–∫—Ä–µ–º–∏–º –µ–ª–µ–º–µ–Ω—Ç–æ–º**, –∞ —Ç—Ä–∏–º–∞—Ç–∏ –π–æ–≥–æ —è–∫ `el.label` (—è–∫ –≤–∏—â–µ).
–ê–ª–µ —è–∫—â–æ —Ç–æ–±—ñ —Ç—Ä–µ–±–∞ —â–µ –π **–≤—ñ–ª—å–Ω–∏–π ‚Äú—Ç–µ–∫—Å—Ç –Ω–∞ –ø–æ–ª–æ—Ç–Ω—ñ‚Äù** ‚Äî —Ç–æ–¥—ñ `TextLabelElement` –¥–æ—Ä–µ—á–Ω–∏–π.

---

## 5) –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–µ –º–µ–Ω—é: ‚Äú–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ ‚Üí –ü—ñ–¥–ø–∏—Å‚Äù

### 5.1. –°—Ç–∞–Ω –º–µ–Ω—é (–ø—Ä–∏–∫–ª–∞–¥)

–£ `useDiagramStore`/state –¥–æ–¥–∞–π:

```js
const [contextMenu, setContextMenu] = useState({
  visible: false,
  x: 0,
  y: 0,
  elementId: null,
});
```

### 5.2. –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –ø–æ –ü–ö–ú

–£ –µ–ª–µ–º–µ–Ω—Ç—ñ –º–∏ –≤–∂–µ –ø–µ—Ä–µ–¥–∞–ª–∏ `onContextMenu={(e)=>...}`. –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è:

```js
function handleElementContextMenu(e, el) {
  e.evt.preventDefault();
  const stage = e.target.getStage();
  const pos = stage.getPointerPosition();

  setContextMenu({
    visible: true,
    x: pos.x,
    y: pos.y,
    elementId: el.id,
  });
}
```

---

## 6) –ü–∞–Ω–µ–ª—å ‚Äú–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –ø—ñ–¥–ø–∏—Å—É‚Äù (UI –≤ –º–µ–Ω—é)

–ù–∏–∂—á–µ ‚Äî ‚Äú—á–∏—Å—Ç–∏–π‚Äù –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π UI –±–µ–∑ –ø—Ä–∏–≤‚Äô—è–∑–∫–∏ –¥–æ MUI (–∞–ª–µ –ª–µ–≥–∫–æ –∞–¥–∞–ø—Ç—É—î—Ç—å—Å—è).

üìÅ `app/diagram/components/LabelSettingsPanel.js`

```jsx
"use client";
import React from "react";

export default function LabelSettingsPanel({ element, updateElement }) {
  const label = element?.label || {};

  const setLabel = (patch) => {
    updateElement(element.id, {
      label: { ...label, ...patch },
    });
  };

  return (
    <div style={{ display: "grid", gap: 8, padding: 10, minWidth: 260 }}>
      <div style={{ fontWeight: 600 }}>–ü—ñ–¥–ø–∏—Å</div>

      <label style={{ display: "grid", gap: 4 }}>
        –ù–∞–∑–≤–∞
        <input
          value={label.text || ""}
          onChange={(e) => setLabel({ text: e.target.value })}
          placeholder="–í–∫–∞–∂—ñ—Ç—å –Ω–∞–∑–≤—É"
        />
      </label>

      <label style={{ display: "flex", gap: 8, alignItems: "center" }}>
        <input
          type="checkbox"
          checked={!!label.visible}
          onChange={(e) => setLabel({ visible: e.target.checked })}
        />
        –í—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏ –ø—ñ–¥–ø–∏—Å
      </label>

      <label style={{ display: "grid", gap: 4 }}>
        –ü–æ–∑–∏—Ü—ñ—è
        <select
          value={label.position || "top"}
          onChange={(e) => setLabel({ position: e.target.value })}
        >
          <option value="top">–ó–≤–µ—Ä—Ö—É</option>
          <option value="bottom">–ó–Ω–∏–∑—É</option>
          <option value="left">–ó–ª—ñ–≤–∞</option>
          <option value="right">–°–ø—Ä–∞–≤–∞</option>
        </select>
      </label>

      <label style={{ display: "grid", gap: 4 }}>
        –†–æ–∑–º—ñ—Ä —à—Ä–∏—Ñ—Ç—É
        <input
          type="number"
          min={6}
          max={72}
          value={label.fontSize ?? 14}
          onChange={(e) => setLabel({ fontSize: Number(e.target.value) })}
        />
      </label>

      <label style={{ display: "grid", gap: 4 }}>
        –¢–æ–≤—â–∏–Ω–∞ (weight)
        <select
          value={label.fontWeight || "regular"}
          onChange={(e) => setLabel({ fontWeight: e.target.value })}
        >
          <option value="light">Light</option>
          <option value="regular">Regular</option>
          <option value="medium">Medium</option>
          <option value="bold">Bold</option>
        </select>
      </label>

      <label style={{ display: "grid", gap: 4 }}>
        –ö–æ–ª—ñ—Ä
        <input
          type="color"
          value={label.color || "#000000"}
          onChange={(e) => setLabel({ color: e.target.value })}
        />
      </label>
    </div>
  );
}
```

---

## 7) updateElement ‚Äî –æ–¥–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è, —è–∫–∞ –≤—Å–µ –≤–∏—Ä—ñ—à—É—î

–£ store:

```js
function updateElement(id, patch) {
  setSymbols((prev) =>
    prev.map((el) => (el.id === id ? { ...el, ...patch } : el))
  );
}
```

---

## 8) –í–∞–∂–ª–∏–≤–∏–π –º–æ–º–µ–Ω—Ç –ø—Ä–æ Ctrl+Click —ñ selection

–¢–∏ –≤–∂–µ –ø—Ä–æ—Å–∏–≤, —â–æ–± –µ–ª–µ–º–µ–Ω—Ç–∏ ‚Äú–Ω–µ –∑–∞–≤–∞–∂–∞–ª–∏ –≤–∏–¥—ñ–ª–µ–Ω–Ω—é‚Äù.
–¢–æ–º—É –¥–ª—è `LabelText` —è –≤–∏—Å—Ç–∞–≤–∏–≤ `listening={false}` ‚Äî –≤—ñ–Ω **–Ω–µ –ª–æ–≤–∏—Ç—å –∫–ª—ñ–∫–∏** –≤–∑–∞–≥–∞–ª—ñ.

---

# –ì–æ—Ç–æ–≤–æ ‚úÖ

–¢–µ–ø–µ—Ä —É —Ç–µ–±–µ:

* –ø—ñ–¥–ø–∏—Å —è–∫ —Å–∏—Å—Ç–µ–º–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞ –µ–ª–µ–º–µ–Ω—Ç–∞ (`el.label`)
* –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–µ –º–µ–Ω—é –≤—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –ø–æ –ü–ö–ú
* —É –º–µ–Ω—é –∑–º—ñ–Ω—é—é—Ç—å—Å—è **–Ω–∞–∑–≤–∞ + visible + –ø–æ–∑–∏—Ü—ñ—è + size + weight**
* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∏–π —Ç–µ–∫—Å—Ç ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π (—á–µ—Ä–µ–∑ `rotation`)

---

–Ø–∫ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫ —è –æ–¥—Ä–∞–∑—É –º–æ–∂—É –¥–æ–ø–∏—Å–∞—Ç–∏:

1. **Material-UI –≤–µ—Ä—Å—ñ—é** —Ü—å–æ–≥–æ `LabelSettingsPanel` (–≥–∞—Ä–Ω–æ –≤ —Ç–≤–æ—î–º—É —Å—Ç–∏–ª—ñ)
2. –ü—ñ–¥–ø–∏—Å –¥–ª—è **–ª—ñ–Ω—ñ–π/—Å—Ç—Ä—ñ–ª–æ–∫ –ø–µ—Ä–µ—Ö–æ–¥—É** (—Ç–∞–º —â–µ anchor —ñ mid-point —Ç—Ä–µ–±–∞)

–°–∫–∞–∂–∏: **MUI —á–∏ –ø–æ–∫–∏ plain?**
